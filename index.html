<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>çµŒæ¸ˆãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«æŒ‡æ¨™åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (2005-2025)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', 'Meiryo', sans-serif; margin: 20px; color: #333; background: #fafafa; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; }
        
        /* å…è²¬äº‹é …ã‚¹ã‚¿ã‚¤ãƒ« */
        .disclaimer {
            background: #fff5f5; border-left: 5px solid #fc8181; padding: 15px; margin-bottom: 25px;
            border-radius: 8px; font-size: 14px; color: #c53030;
        }
        .disclaimer strong { display: block; margin-bottom: 5px; }

        .controls { 
            display: flex; flex-wrap: wrap; gap: 25px; margin-bottom: 25px; padding: 25px; 
            background: #ffffff; border-radius: 12px; border: 1px solid #e1e4e8; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group strong { font-size: 15px; color: #444; border-left: 4px solid #3498db; padding-left: 8px; }

        #chart { 
            width: 100%; height: 600px; background: #fff; border: 1px solid #eee; 
            position: relative; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden; margin-bottom: 40px;
        }

        .source-info {
            background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e1e4e8; margin-bottom: 30px;
        }
        .source-info h3 { margin-top: 0; font-size: 18px; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .main-source { margin-bottom: 15px; padding: 12px; background: #fff9db; border-radius: 6px; font-size: 14px; border-left: 5px solid #f1c40f; }
        .source-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 12px; list-style: none; padding: 0; }
        .source-item { font-size: 13px; color: #555; padding: 8px; background: #f8f9fa; border-radius: 4px; }
        .source-item strong { color: #333; display: inline-block; width: 120px; }
        .source-item a { color: #3498db; text-decoration: none; word-break: break-all; font-family: monospace; }
        .source-item a:hover { text-decoration: underline; }

        .footer { text-align: center; padding: 40px 0; border-top: 1px solid #ddd; margin-top: 20px; }
        .repo-link {
            display: inline-flex; align-items: center; padding: 12px 24px;
            background: #24292e; color: #fff; text-decoration: none; border-radius: 8px;
            font-weight: bold; transition: background 0.3s;
        }
        .repo-link:hover { background: #444; }
        .repo-link svg { margin-right: 10px; }

        .line { fill: none !important; stroke-width: 3.5px !important; stroke-linejoin: round; stroke-linecap: round; }
        .tooltip { 
            position: absolute; padding: 14px; background: rgba(30, 39, 46, 0.95); color: #fff; 
            border-radius: 8px; pointer-events: none; font-size: 13px; z-index: 100; visibility: hidden; 
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }
        label { cursor: pointer; margin-right: 15px; font-size: 14px; font-weight: 500; }
        select { padding: 10px 15px; border-radius: 6px; border: 1px solid #cbd5e0; font-size: 14px; cursor: pointer; }
        .axis-label { font-size: 12px; font-weight: bold; fill: #7f8c8d; }
        .grid line { stroke: #f1f2f6; shape-rendering: crispEdges; }
    </style>
</head>
<body>

<div class="container">
    <h2>ã‚°ãƒ­ãƒ¼ãƒãƒ«çµŒæ¸ˆãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«æŒ‡æ¨™åˆ†æ (2005-2025)</h2>
    
    <div class="disclaimer">
        <strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã«é–¢ã™ã‚‹ã”æ³¨æ„</strong>
        æœ¬ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€å„å›½ã®å…¬çš„çµ±è¨ˆãŠã‚ˆã³IMFã®äºˆæ¸¬å€¤ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€ç”ŸæˆAIã‚’ç”¨ã„ã¦åé›†ãƒ»æ•´ç†ãƒ»è£œå®Œã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚å¤§å±€çš„ãªãƒˆãƒ¬ãƒ³ãƒ‰ã®æŠŠæ¡ã‚’ç›®çš„ã¨ã—ã¦ãŠã‚Šã€é€šè²¨æ›ç®—ã‚„æ¨è¨ˆå‡¦ç†ã«ã‚ˆã‚Šæ•°å€¤ã®ç´°éƒ¨ã§å®Ÿéš›ã®çµ±è¨ˆã¨å·®ç•°ãŒç”Ÿã˜ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å³å¯†ãªæ•°å€¤ã‚’å¿…è¦ã¨ã™ã‚‹å ´åˆã¯ã€å„çµ±è¨ˆå±€ã®ä¸€æ¬¡è³‡æ–™ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
    </div>

    <div class="controls">
        <div class="control-group">
            <strong>æ¯”è¼ƒå¯¾è±¡ã®å›½ã‚’é¸æŠ:</strong>
            <div>
                <label><input type="checkbox" class="cb" value="japan" checked> æ—¥æœ¬(USD)</label>
                <label><input type="checkbox" class="cb" value="usa" checked> ç±³å›½</label>
                <label><input type="checkbox" class="cb" value="germany" checked> ãƒ‰ã‚¤ãƒ„</label>
                <label><input type="checkbox" class="cb" value="china" checked> ä¸­å›½</label>
                <label><input type="checkbox" class="cb" value="india" checked> ã‚¤ãƒ³ãƒ‰</label>
                <label style="color: #e67e22;"><input type="checkbox" class="cb" value="japan_yen"> æ—¥æœ¬(åç›®/å††å»ºã¦)</label>
            </div>
        </div>
        <div class="control-group">
            <strong>è¡¨ç¤ºæŒ‡æ¨™:</strong>
            <select id="metric-select">
                <option value="auto_gdp">åç›®GDP (å…±é€šãƒ™ãƒ¼ã‚¹æ¯”è¼ƒ)</option>
            </select>
        </div>
    </div>

    <div id="chart"></div>

    <div class="source-info">
        <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãƒ»å„å›½çµ±è¨ˆå±€å…¬å¼ã‚µã‚¤ãƒˆ</h3>
        <div class="main-source">
            ğŸ’¡ <strong>å‡ºå…¸æ§‹æˆ:</strong> 2023å¹´ã¾ã§ã®å®Ÿç¸¾å€¤ã¯ä¸»ã«å„å›½çµ±è¨ˆå±€ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã€‚ç›´è¿‘ãŠã‚ˆã³2025å¹´ã®äºˆæ¸¬å€¤ã¯ <a href="https://www.imf.org/en/Publications/WEO/weo-database/2024/October" target="_blank">IMF World Economic Outlook (Oct 2024)</a> ã«åŸºã¥ãã¾ã™ã€‚
        </div>
        <ul class="source-list">
            <li class="source-item"><strong>ç±³å›½ (BEA):</strong> <a href="https://www.bea.gov/data/gdp/gross-domestic-product" target="_blank">https://www.bea.gov/data/gdp/gross-domestic-product</a></li>
            <li class="source-item"><strong>ãƒ‰ã‚¤ãƒ„ (Destatis):</strong> <a href="https://www.destatis.de/EN/Themes/Economy/National-Accounts/_node.html" target="_blank">https://www.destatis.de/EN/Themes/Economy/National-Accounts/_node.html</a></li>
            <li class="source-item"><strong>ä¸­å›½ (NBS):</strong> <a href="http://www.stats.gov.cn/english/" target="_blank">http://www.stats.gov.cn/english/</a></li>
            <li class="source-item"><strong>ã‚¤ãƒ³ãƒ‰ (MoSPI):</strong> <a href="https://www.mospi.gov.in/" target="_blank">https://www.mospi.gov.in/</a></li>
            <li class="source-item"><strong>æ—¥æœ¬ (å†…é–£åºœ):</strong> <a href="https://www.esri.cao.go.jp/jp/sna/menu.html" target="_blank">https://www.esri.cao.go.jp/jp/sna/menu.html</a></li>
        </ul>
    </div>

    <div class="footer">
        <a href="https://github.com/maabou512/gdp_economics" class="repo-link" target="_blank">
            <svg height="20" width="20" viewBox="0 0 16 16" fill="white"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
            GitHub Repository
        </a>
    </div>
</div>

<script>
const metricNames = {
    "auto_gdp": "åç›®GDP (å…†USD / å…†å††)",
    "gdp_nominal_total_trillion_usd": "åç›®GDP (å…†USD)",
    "gdp_nominal_total_trillion_yen": "åç›®GDP (å…†å††)",
    "gdp_per_capita_usd": "ä¸€äººå½“ãŸã‚Šåç›®GDP (USD)",
    "ict_ratio_to_gdp_percent": "ICTç”£æ¥­ã®å¯¾GDPæ¯”ç‡ (%)",
    "digital_balance_of_payments_billion_usd": "ãƒ‡ã‚¸ã‚¿ãƒ«åæ”¯ (Billion USD)",
    "digital_balance_of_payments_trillion_yen": "ãƒ‡ã‚¸ã‚¿ãƒ«åæ”¯ (å…†å††)"
};

const margin = {top: 60, right: 130, bottom: 100, left: 85}, 
      width = 1100 - margin.left - margin.right, 
      height = 600 - margin.top - margin.bottom;

const colors = { japan: "#e74c3c", usa: "#3498db", germany: "#2c3e50", china: "#9b59b6", india: "#27ae60", japan_yen: "#e67e22" };

const svg = d3.select("#chart").append("svg")
    .attr("viewBox", `0 0 1100 600`)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

const tooltip = d3.select("body").append("div").attr("class", "tooltip");

let allData = {};
const files = [
    {id:"japan", url:"data/gdp_japan.json"},
    {id:"usa", url:"data/gdp_usa.json"},
    {id:"germany", url:"data/gdp_germany.json"},
    {id:"china", url:"data/gdp_china.json"},
    {id:"india", url:"data/gdp_india.json"},
    {id:"japan_yen", url:"data/gdp_japan_yen.json"}
];

Promise.all(files.map(f => d3.json(f.url).then(d => ({id:f.id, d})).catch(e => null)))
.then(res => {
    const keys = new Set();
    res.forEach(r => {
        if(r && r.d) {
            allData[r.id] = r.d;
            r.d.forEach(obj => {
                Object.keys(obj).forEach(k => {
                    if(!["year", "iso_date", "country", "status", "source_urls"].includes(k) && typeof obj[k] === "number") {
                        keys.add(k);
                    }
                });
            });
        }
    });

    const select = d3.select("#metric-select");
    Array.from(keys).sort().forEach(k => {
        const label = metricNames[k] || k.replace(/_/g, ' ');
        if (!select.selectAll("option").filter(function() { return d3.select(this).property("value") === k; }).size()) {
            select.append("option").attr("value", k).text(label);
        }
    });
    update();
});

d3.selectAll(".cb, #metric-select").on("change", update);

function update() {
    const metric = d3.select("#metric-select").property("value");
    const active = [];
    d3.selectAll(".cb:checked").each(function() { active.push(this.value); });

    const plotData = active.map(id => {
        if(!allData[id]) return null;
        return {
            id: id,
            values: allData[id].map(d => {
                let v = (metric === "auto_gdp") ? (d.gdp_nominal_total_trillion_usd || d.gdp_nominal_total_trillion_yen) : d[metric];
                return { year: +d.year, value: v === null ? null : +v, status: d.status || "N/A", source: d.source_urls ? (Array.isArray(d.source_urls) ? d.source_urls[0] : d.source_urls) : "N/A" };
            }).filter(v => v.value !== null && !isNaN(v.value))
        };
    }).filter(d => d && d.values.length > 0);

    svg.selectAll("*").remove();
    if(plotData.length === 0) return;

    const x = d3.scaleLinear().domain([2005, 2025]).range([0, width]);
    const isMixed = active.includes("japan_yen") && (metric === "auto_gdp" || metric.includes("usd"));

    const yLeft = d3.scaleLinear()
        .domain([
            Math.min(0, d3.min(plotData.filter(d => isMixed ? d.id !== 'japan_yen' : true), c => d3.min(c.values, d => d.value))),
            d3.max(plotData.filter(d => isMixed ? d.id !== 'japan_yen' : true), c => d3.max(c.values, d => d.value)) * 1.1
        ]).range([height, 0]);

    svg.append("g").attr("class", "grid").call(d3.axisLeft(yLeft).tickSize(-width).tickFormat(""));
    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.format("d")).ticks(10));
    svg.append("g").call(d3.axisLeft(yLeft));

    svg.append("text").attr("class", "axis-label").attr("transform", "rotate(-90)").attr("y", -70).attr("x", -height/2).attr("text-anchor", "middle").text(metricNames[metric] || "å€¤");
    
    let yRight;
    if(isMixed && allData["japan_yen"]) {
        const yenData = plotData.find(d => d.id === 'japan_yen');
        const yenMax = d3.max(yenData.values, d => d.value);
        yRight = d3.scaleLinear().domain([0, yenMax * 1.1]).range([height, 0]);
        svg.append("g").attr("transform", `translate(${width},0)`).call(d3.axisRight(yRight));
        svg.append("text").attr("x", width + 15).attr("y", -15).attr("fill", colors.japan_yen).text("å…†å††è»¸ (JPY)").style("font-size", "12px").style("font-weight", "bold");
    }

    const lineGen = (id) => d3.line().x(d => x(d.year)).y(d => (id === 'japan_yen' && isMixed) ? yRight(d.value) : yLeft(d.value)).curve(d3.curveMonotoneX);

    plotData.forEach(d => {
        svg.append("path").datum(d.values).attr("class", "line").attr("stroke", colors[d.id]).attr("d", lineGen(d.id));
        svg.selectAll(".dot-" + d.id).data(d.values).enter().append("circle")
            .attr("cx", v => x(v.year)).attr("cy", v => (d.id === 'japan_yen' && isMixed) ? yRight(v.value) : yLeft(v.value))
            .attr("r", 5).attr("fill", colors[d.id]).attr("stroke", "#fff").attr("stroke-width", 1.5).style("cursor", "pointer")
            .on("mouseover", (e, v) => {
                let unit = "";
                if (metric.includes("percent") || metric.includes("ratio")) unit = "%";
                else if (d.id === 'japan_yen' || metric.includes("yen")) unit = "å…†å††";
                else if (metric.includes("per_capita")) unit = "USD";
                else if (metric.includes("billion")) unit = "Billion USD";
                else if (metric.includes("trillion") || metric === "auto_gdp") unit = "å…†USD";

                tooltip.style("visibility", "visible")
                       .html(`<strong>${d.id.toUpperCase()} - ${v.year}å¹´</strong><div style="font-size:18px; font-weight:bold; color:#00d8ff;">${v.value.toLocaleString()} <span style="font-size:12px">${unit}</span></div>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${v.status}<br><span style="font-size:9px; color:#aaa; word-break:break-all;">Ref: ${v.source}</span>`);
            })
            .on("mousemove", e => tooltip.style("top", (e.pageY - 100) + "px").style("left", (e.pageX + 20) + "px"))
            .on("mouseout", () => tooltip.style("visibility", "hidden"));
            
        const last = d.values[d.values.length - 1];
        if(last) {
            svg.append("text").attr("x", x(last.year) + 10).attr("y", (d.id === 'japan_yen' && isMixed) ? yRight(last.value) : yLeft(last.value))
                .text(d.id.toUpperCase()).attr("fill", colors[d.id]).style("font-weight","bold").style("font-size", "13px").style("dominant-baseline", "middle");
        }
    });
}
</script>
</body>
</html>