<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>経済・デジタル指標分析ダッシュボード</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: 'Hiragino Sans', 'Meiryo', sans-serif; margin: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        .controls { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 15px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #ddd; }
        #chart { width: 100%; height: 550px; background: #fff; border: 1px solid #eee; position: relative; }
        .line { fill: none !important; stroke-width: 3.5px !important; }
        .tooltip { position: absolute; padding: 12px; background: rgba(0,0,0,0.85); color: #fff; border-radius: 5px; pointer-events: none; font-size: 13px; z-index: 100; visibility: hidden; }
        label { cursor: pointer; margin-right: 12px; font-size: 14px; }
        select { padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h2>グローバル経済・デジタル指標比較 (2005-2025)</h2>
    <div class="controls">
        <div>
            <strong>表示対象:</strong><br>
            <label><input type="checkbox" class="cb" value="japan" checked> 日本(USD)</label>
            <label><input type="checkbox" class="cb" value="usa" checked> 米国</label>
            <label><input type="checkbox" class="cb" value="germany" checked> ドイツ</label>
            <label><input type="checkbox" class="cb" value="china" checked> 中国</label>
            <label><input type="checkbox" class="cb" value="india" checked> インド</label>
            <label style="color: #e67e22; font-weight: bold;"><input type="checkbox" class="cb" value="japan_yen"> 日本(円建て)</label>
        </div>
        <div>
            <strong>指標を選択:</strong><br>
            <select id="metric-select">
                <option value="auto_gdp">名目GDP (兆USD / 日本のみ円)</option>
            </select>
        </div>
    </div>
    <div id="chart"></div>
</div>

<script>
// キー名と表示名の対応表
const metricNames = {
    "auto_gdp": "名目GDP (一括比較)",
    "gdp_nominal_total_trillion_usd": "名目GDP (兆USD)",
    "gdp_nominal_total_billion_usd": "名目GDP (十億USD)",
    "gdp_nominal_total_trillion_yen": "名目GDP (兆円)",
    "gdp_per_capita_usd": "一人当たりGDP (USD)",
    "ict_industry_gdp_share_percent": "ICT産業の対GDP比率 (%)",
    "ict_ratio_to_gdp_percent": "ICT産業の対GDP比率 (%)",
    "digital_balance_of_payments_trillion_yen": "デジタル収支 (兆円)",
    "digital_services_export_trillion_yen": "デジタルサービス輸出 (兆円)",
    "digital_services_import_trillion_yen": "デジタルサービス輸入 (兆円)"
};

const margin = {top: 50, right: 100, bottom: 50, left: 80}, width = 1000 - margin.left - margin.right, height = 550 - margin.top - margin.bottom;
const colors = {japan: "#e74c3c", usa: "#3498db", germany: "#2c3e50", china: "#9b59b6", india: "#27ae60", japan_yen: "#e67e22"};

const svg = d3.select("#chart").append("svg")
    .attr("viewBox", "0 0 1000 550")
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

const tooltip = d3.select("body").append("div").attr("class", "tooltip");

let allData = {};
const files = [
    {id:"japan", url:"data/gdp_japan.json"},
    {id:"usa", url:"data/gdp_usa.json"},
    {id:"germany", url:"data/gdp_germany.json"},
    {id:"china", url:"data/gdp_china.json"},
    {id:"india", url:"data/gdp_india.json"},
    {id:"japan_yen", url:"data/gdp_japan_yen.json"}
];

Promise.all(files.map(f => d3.json(f.url).then(d => ({id:f.id, d})).catch(e => null)))
.then(res => {
    const keys = new Set();
    res.forEach(r => {
        if(r) {
            allData[r.id] = r.d;
            r.d.forEach(obj => {
                Object.keys(obj).forEach(k => {
                    if(k !== "year" && typeof obj[k] === "number") keys.add(k);
                });
            });
        }
    });

    const select = d3.select("#metric-select");
    Array.from(keys).sort().forEach(k => {
        // キー名を日本語に変換、なければそのまま表示
        const label = metricNames[k] || k.replace(/_/g, ' ');
        // 重複（ICT比率の別名など）を避ける
        if (!select.selectAll("option").filter(function() { return d3.select(this).text() === label; }).size()) {
            select.append("option").attr("value", k).text(label);
        }
    });

    update();
});

d3.selectAll(".cb, #metric-select").on("change", update);

function update() {
    const metric = d3.select("#metric-select").property("value");
    const active = [];
    d3.selectAll(".cb:checked").each(function() { active.push(this.value); });

    const plotData = active.map(id => {
        if(!allData[id]) return null;
        return {
            id: id,
            values: allData[id].map(d => {
                let v = 0;
                if(metric === "auto_gdp") {
                    v = d.gdp_nominal_total_trillion_usd || (d.gdp_nominal_total_billion_usd / 1000) || d.gdp_nominal_total_trillion_yen || 0;
                } else if(metric.includes("ict_")) {
                    v = d.ict_industry_gdp_share_percent || d.ict_ratio_to_gdp_percent || 0;
                } else {
                    v = d[metric] || 0;
                }
                return {year: +d.year, value: +v};
            }).filter(v => v.value !== 0).sort((a,b) => a.year - b.year)
        };
    }).filter(d => d && d.values.length > 0);

    svg.selectAll("*").remove();
    if(plotData.length === 0) return;

    const x = d3.scaleLinear().domain([2005, 2025]).range([0, width]);
    
    // 他国との比較を可能にするため、基本は全データを同じ軸で計算
    // ただし、日本(円)が含まれ、かつ他のUSD指標と比較している場合のみ2軸にする
    const isMixed = active.includes("japan_yen") && (metric === "auto_gdp" || metric.includes("usd"));

    const yLeft = d3.scaleLinear()
        .domain([0, d3.max(plotData.filter(d => isMixed ? d.id !== 'japan_yen' : true), c => d3.max(c.values, d => d.value)) * 1.1])
        .range([height, 0]);

    const yRight = d3.scaleLinear()
        .domain([0, d3.max(plotData.filter(d => d.id === 'japan_yen'), c => d3.max(c.values, d => d.value)) * 1.1])
        .range([height, 0]);

    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
    svg.append("g").call(d3.axisLeft(yLeft));
    
    if(isMixed) {
        svg.append("g").attr("transform", `translate(${width},0)`).call(d3.axisRight(yRight));
        svg.append("text").attr("x", width + 10).attr("y", -10).attr("fill", colors.japan_yen).text("兆円軸").style("font-size", "12px");
    }

    const lineGen = (id) => d3.line()
        .x(d => x(d.year))
        .y(d => (id === 'japan_yen' && isMixed) ? yRight(d.value) : yLeft(d.value));

    plotData.forEach(d => {
        svg.append("path").datum(d.values).attr("class", "line")
            .attr("stroke", colors[d.id]).attr("d", lineGen(d.id));

        // ツールチップ用
        svg.selectAll(".dot-" + d.id).data(d.values).enter().append("circle")
            .attr("cx", v => x(v.year)).attr("cy", v => (d.id === 'japan_yen' && isMixed) ? yRight(v.value) : yLeft(v.value))
            .attr("r", 5).attr("fill", colors[d.id]).style("opacity", 0.1)
            .on("mouseover", (e, v) => {
                tooltip.style("visibility", "visible").html(`<strong>${d.id.toUpperCase()}</strong><br>${v.year}年: ${v.value.toLocaleString()}`);
            })
            .on("mousemove", e => tooltip.style("top", (e.pageY - 50) + "px").style("left", (e.pageX + 15) + "px"))
            .on("mouseout", () => tooltip.style("visibility", "hidden"));
            
        const last = d.values[d.values.length - 1];
        svg.append("text").attr("x", x(last.year)+5).attr("y", (d.id === 'japan_yen' && isMixed) ? yRight(last.value) : yLeft(last.value))
            .text(d.id.toUpperCase()).attr("fill", colors[d.id]).style("font-weight","bold").style("font-size", "12px");
    });
}
</script>
</body>
</html>